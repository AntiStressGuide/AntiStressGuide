<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enhanced Stress Index (WHO-Based)</title>

<link rel="icon" type="image/png" href="Logo AntiStressGuide.png">
<link rel="shortcut icon" type="image/x-icon" href="Logo AntiStressGuide.ico">
<link rel="apple-touch-icon" sizes="180x180" href="Logo AntiStressGuide.png">

:root{
  --bg:#eaf5e8;
  --card:#fff;
  --accent:#2E5D3D;
  --bar-height:36px;
}

body{
  font-family:Inter, Roboto, Arial, sans-serif;
  background:var(--bg);
  margin:0;
  padding:18px;
  color:#143d2b;
}

.container{
  max-width:900px;
  margin:18px auto;
  background:var(--card);
  padding:22px;
  border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}

/* Header */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:18px;
}

.logo{height:44px}

h1,h2{
  color:var(--accent);
  text-align:center;
  margin:8px 0;
}

/* Fragen */
.question{
  margin:10px 0;
  padding:12px;
  border-radius:10px;
}

.question:nth-child(odd){background:#f3fbf6}

label{display:block;margin:6px 0;font-size:16px}
select,input[type=email],input[type=text]{width:100%;padding:10px;border-radius:20px;border:1px solid #ddd;font-size:15px}
input[type=radio],input[type=checkbox]{transform:scale(1.1);margin-right:8px}

.range-labels{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  color:#556;
  margin-top:6px;
}

/* Slider: Vollbreite im eigenen Container */
#stressContainer {
  max-width:700px;      /* begrenzt Breite */
  margin:10px auto;     /* zentriert */
  padding:10px;
}

input.slider {
  width: 100%;
  height: 28px;
  background: #c8e6c9;
  border-radius: 10px;
  outline: none;
  margin-top: 8px;
}

input.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 30px;
  height: 30px;
  background: #2E5D3D;
  border-radius: 50%;
  cursor: pointer;
  margin-top: -5px;
}

input.slider::-moz-range-thumb {
  width: 30px;
  height: 30px;
  background: #2E5D3D;
  border-radius: 50%;
  cursor: pointer;
}

input.slider::-moz-range-track {
  height: 28px;
  background: #c8e6c9;
  border-radius: 10px;
}

/* Submit Buttons */
.submit-container{
  display:flex;
  gap:12px;
  margin-top:14px;
}

.submit-container button{
  flex:1;
  padding:12px;
  border-radius:10px;
  border:0;
  background:var(--accent);
  color:#fff;
  font-weight:700;
  cursor:pointer;
  font-size:16px;
}

.submit-container button.secondary{background:#1766a0}

#errorMessage{
  color:#b00020;
  text-align:center;
  display:none;
  margin-top:8px;
}

#results{
  display:none;
  margin-top:18px;
  padding:16px;
  border-radius:10px;
  background:#f0fbf5;
  text-align:center;
}

/* Bar styles */
.bar-container{
  position:relative;
  width:100%;
  height:var(--bar-height);
  background:#e6f3ea;
  border-radius:999px;
  overflow:visible;
  margin:12px 0;
}

.bar-fill{
  position:absolute;
  left:0;
  top:0;
  height:100%;
  width:0%;
  border-radius:999px;
  transition:width .4s ease, background-color .2s;
  display:flex;
  align-items:center;
  justify-content:center;
}

.bar-text{
  position:absolute;
  left:0;
  top:0;
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  font-weight:800;
  color:black;
}

.breakdown{ text-align:left; margin:12px 0 0 8px; }

footer{ text-align:center;margin-top:18px;padding:10px;color:#1f4b39 }

@media(max-width:640px){
  .submit-container{flex-direction:column}
}

</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img class="logo" src="Logo AntiStressGuide.png" alt="Logo">
      <nav><a href="index.html">Home</a> ¬∑ <a href="Affirmations.html">Affirmations</a></nav>
    </div>

    <h1>Enhanced Stress Index (WHO-Based)</h1>

    <form id="assessmentForm" autocomplete="off">
      <!-- Demographics -->
      <h2>Demographics</h2>
      <div class="question group">
        <label>Age</label>
        <select name="age" required>
          <option value="" disabled selected>Alter w√§hlen</option>
          <option value="18-30">18‚Äì30</option>
          <option value="31-50">31‚Äì50</option>
          <option value="51-70">51‚Äì70</option>
          <option value=">70">&gt;70</option>
        </select>

        <label style="margin-top:10px">Gender</label>
        <select name="gender" required>
          <option value="" disabled selected>Geschlecht w√§hlen</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <!-- Medical -->
      <h2>Medical Conditions</h2>
      <div class="question group" id="medicalBlock">
        <label>Haben Sie chronische Erkrankungen oder k√ºrzlich Operationen?</label>
        <label><input type="checkbox" name="medical" value="None"> None</label>
        <label><input type="checkbox" name="medical" value="Cardiovascular Disease"> Cardiovascular Disease</label>
        <label><input type="checkbox" name="medical" value="Mental Health Condition"> Mental Health Condition</label>
        <label><input type="checkbox" name="medical" value="Recent Surgery"> Recent Surgery</label>
        <label><input type="checkbox" name="medical" value="Other"> Other</label>
      </div>

      <!-- Nutrition -->
      <h2>Nutrition</h2>
      <div class="question group">
        <label>Overall diet quality</label>
        <label><input type="radio" name="nutrition" value="0" required> Very healthy diet ‚Äî Sugar &lt;5%, Salt &lt;3 g/day, Saturated fat &lt;5%</label>
        <label><input type="radio" name="nutrition" value="1"> Healthy diet ‚Äî Sugar 5‚Äì7%, Salt 3‚Äì5 g, Saturated fat 5‚Äì7%</label>
        <label><input type="radio" name="nutrition" value="2"> Average diet ‚Äî Sugar 5‚Äì10%, Salt 5‚Äì7 g, Saturated fat 7‚Äì10%</label>
        <label><input type="radio" name="nutrition" value="3"> Unhealthy diet ‚Äî Sugar 10‚Äì15%, Salt 7‚Äì10 g, Saturated fat 10‚Äì15%</label>
        <label><input type="radio" name="nutrition" value="4"> Very unhealthy diet ‚Äî Sugar &gt;15%, Salt &gt;10 g, Saturated fat &gt;15%</label>
      </div>

      <!-- Physical Activity -->
      <h2>Physical Activity</h2>
      <div class="question group">
        <label>Weekly Physical Activity:</label>
        <label><input type="radio" name="physical" value="Little or no activity" required> &lt;150 min/week, no strength</label>
        <label><input type="radio" name="physical" value="150‚Äì300 min/week, 0‚Äì1 strength"> 150‚Äì300 min/week, strength 0‚Äì1 days</label>
        <label><input type="radio" name="physical" value="150‚Äì300 min/week, 2+ strength"> 150‚Äì300 min/week, strength 2+ days</label>
        <label><input type="radio" name="physical" value=">300 min/week, 2+ strength"> &gt;300 min/week, strength 2+ days</label>
        <label><input type="radio" name="physical" value="Vigorous 75‚Äì150+ min/week"> Vigorous 75‚Äì150+ min/week, strength 2+ days</label>
      </div>

      <!-- Harmful Habits -->
      
      <!-- Harmful Habits -->
      <h2>Harmful Habits</h2>
      <div class="question group">
        <label>Alcohol consumption</label>
        <label><input type="radio" name="alcohol" value="0" required> None (0 drinks/week)</label>
        <label><input type="radio" name="alcohol" value="1"> Low risk (Women:1‚Äì7, Men:1‚Äì14/week)</label>
        <label><input type="radio" name="alcohol" value="2"> Moderate risk (Women:8‚Äì14, Men:15‚Äì28/week)</label>
        <label><input type="radio" name="alcohol" value="3"> High risk (Women:15‚Äì21, Men:29‚Äì42/week)</label>
        <label><input type="radio" name="alcohol" value="4"> Very high (&gt;21 / &gt;42/week)</label>
      </div>

      <div class="question group">
        <label>Tobacco use</label>
        <label><input type="radio" name="tobacco" value="0" required> None</label>
        <label><input type="radio" name="tobacco" value="1"> Low (&lt;5/day)</label>
        <label><input type="radio" name="tobacco" value="2"> Moderate (5‚Äì19/day)</label>
        <label><input type="radio" name="tobacco" value="3"> High (20/day)</label>
        <label><input type="radio" name="tobacco" value="4"> Very high (&ge;30/day)</label>
      </div>

      <div class="question group">
        <label>Drug use</label>
        <label><input type="radio" name="drugs" value="0" required> None</label>
        <label><input type="radio" name="drugs" value="1"> Low (occasional use)</label>
        <label><input type="radio" name="drugs" value="2"> Moderate (regular use, risk present)</label>
        <label><input type="radio" name="drugs" value="3"> High (dependence / health risk)</label>
        <label><input type="radio" name="drugs" value="4"> Very high (severe dependence)</label>
      </div>

      <div class="question group">
        <label>Gambling</label>
        <label><input type="radio" name="gambling" value="0" required> None</label>
        <label><input type="radio" name="gambling" value="1"> Low (occasional)</label>
        <label><input type="radio" name="gambling" value="2"> Moderate (regular)</label>
        <label><input type="radio" name="gambling" value="3"> High (frequent)</label>
        <label><input type="radio" name="gambling" value="4"> Very high (pathological)</label>
      </div>

      <!-- Stress & Well-Being (Likert 0-4) -->
      <h2>Stress & Well-Being (0‚Äì4)</h2>
      <div id="questionsContainer"></div>

      <!-- Email -->
      <div class="question group">
        <label>Email (optional)</label>
        <input type="email" name="email" placeholder="you@example.com">
      </div>

      <div class="submit-container">
        <button class="btn-index" type="submit" name="action" value="index">Submit Stress Index</button>
        <button class="btn-individual" type="submit" name="action" value="individual">Submit for Individual Stress Management Sessions</button>
      </div>
      <div id="errorMessage">‚ö†Ô∏è Bitte alle Pflichtfelder ausf√ºllen.</div>
    </form>

    <!-- Results -->
    <div id="results">
      <p id="responseID"></p>
      <p id="totalPoints"></p>
      <p id="categoryColor"></p>
      <div id="breakdown"></div>
      <div id="barChart"></div>
      <button id="newFormBtn" style="margin-top:12px;padding:10px;border-radius:8px;border:0;background:#2E5D3D;color:#fff;cursor:pointer">Neues Formular</button>
    </div>

    <footer style="text-align:center;margin-top:18px;padding:10px;color:#1f4b39">¬© 2025 AntiStressGuide</footer>
  </div>

<script>
/* ---------- CONFIG: Edge function / Web-App URL ---------- */
const EDGE_URL = "https://deine-edge-function-url.com/session"; // <-- bleibt unver√§ndert f√ºr POST

/* ---------- Stress questions (0..4 Likert) ---------- */
const likertLabels = ["Never","Rarely","Sometimes","Often","Very Often"];
const stressQuestions = [
  "In the past month, I felt that things were generally going my way.",
  "During the last month, I felt confident about handling personal problems.",
  "Over the past month, I felt physically and mentally healthy enough to meet daily demands.",
  "In the past month, I was satisfied with my overall well-being and quality of life.",
  "During the last month, I felt energetic and capable of handling both work and personal responsibilities.",
  "Over the past month, I could take breaks and recover adequately during and between workdays.",
  "In the last month, support from colleagues helped me cope with stress.",
  "During the past month, my work schedule allowed me to maintain a healthy work-life balance.",
  "Over the last month, my workload prevented me from completing important personal tasks.",
  "In the past month, I had sufficient control over how I completed my work tasks."
];

/* ---------- Stress questions (0..4 Likert) ---------- */
const likertLabels = ["Never","Rarely","Sometimes","Often","Very Often"];
const stressQuestions = [
  "In the past month, I felt that things were generally going my way.",
  "During the last month, I felt confident about handling personal problems.",
  "Over the past month, I felt physically and mentally healthy enough to meet daily demands.",
  "In the past month, I was satisfied with my overall well-being and quality of life.",
  "During the last month, I felt energetic and capable of handling both work and personal responsibilities.",
  "Over the past month, I could take breaks and recover adequately during and between workdays.",
  "In the last month, support from colleagues helped me cope with stress.",
  "During the past month, my work schedule allowed me to maintain a healthy work-life balance.",
  "Over the last month, my workload prevented me from completing important personal tasks.",
  "In the past month, I had sufficient control over how I completed my work tasks."
];

/* create stress inputs in stressContainer */
const stressContainer = document.getElementById('stressContainer');

stressQuestions.forEach((q, i) => {
  const div = document.createElement('div');
  div.className = 'question';
  div.innerHTML = `
    <label>${i+1}. ${q}</label>
    <input type="range" class="slider" min="0" max="4" value="2" name="q${i}" required>
    <div class="range-labels">${likertLabels.map(l => `<span>${l}</span>`).join('')}</div>
  `;
  stressContainer.appendChild(div);
});



/* ---------- helpers ---------- */
function avg(arr){ const nums = arr.map(Number).filter(n=>!isNaN(n)); return nums.length ? nums.reduce((a,b)=>a+b,0)/nums.length : 0; }
function generateSequentialID(){
  const now = new Date();
  const yearMonth = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}`;
  const key = `internalID_${yearMonth}`;
  let n = parseInt(localStorage.getItem(key) || "0", 10);
  n += 1;
  localStorage.setItem(key, n);
  return `ASG${yearMonth}${String(n).padStart(4,'0')}`;
}

/* ---------- main handling ---------- */
const form = document.getElementById('assessmentForm');
const resultsDiv = document.getElementById('results');
const barChart = document.getElementById('barChart');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const action = e.submitter?.value; // "index" or "individual"
  const err = document.getElementById('errorMessage');
  if(!form.checkValidity()){ err.style.display='block'; return; }
  err.style.display='none';

  const responseID = generateSequentialID();

  // collect stress answers
  const stressAnswers = stressQuestions.map((_,i) => parseInt(form.querySelector(`input[name="q${i}"]`).value, 10));
  const stressScore = avg(stressAnswers); // 0..4

  // habits numeric (0..4)
  const alcohol = parseInt(form.querySelector('input[name="alcohol"]:checked')?.value ?? "0", 10);
  const tobacco = parseInt(form.querySelector('input[name="tobacco"]:checked')?.value ?? "0", 10);
  const drugs = parseInt(form.querySelector('input[name="drugs"]:checked')?.value ?? "0", 10);
  const gambling = parseInt(form.querySelector('input[name="gambling"]:checked')?.value ?? "0", 10);
  const habitsScore = avg([alcohol, tobacco, drugs, gambling]);

  // nutrition numeric 0..4
  const nutritionScore = parseInt(form.querySelector('input[name="nutrition"]:checked')?.value ?? "0", 10);

  // physical: map to 0..4 then invert to score (less activity -> higher risk)
  const physVal = form.querySelector('input[name="physical"]:checked')?.value ?? "Little or no activity";
  let physicalRaw = 0;
  switch(physVal){
    case "Little or no activity": physicalRaw = 0; break;
    case "150‚Äì300 min/week, 0‚Äì1 strength": physicalRaw = 1; break;
    case "150‚Äì300 min/week, 2+ strength": physicalRaw = 2; break;
    case ">300 min/week, 2+ strength": physicalRaw = 3; break;
    case "Vigorous 75‚Äì150+ min/week": physicalRaw = 4; break;
    default: physicalRaw = 0;
  }
  const physicalScore = 4 - physicalRaw; // 0..4 where higher = worse

  // medical list
  const medicalChecks = Array.from(document.querySelectorAll('input[name="medical"]:checked')).map(c=>c.value);
  const medicalList = medicalChecks.includes('None') ? [] : medicalChecks;
  const medicalScore = Math.min(4, medicalList.length);

  // total (average of 5 components 0..4)
  const totalScoreFloat = (stressScore + habitsScore + medicalScore + nutritionScore + physicalScore) / 5;
  const totalScore = totalScoreFloat.toFixed(2);

  // category / color (emoji & CSS color used for bars)
  let category = "", emoji = "", barColor = "#2E5D3D";
  if (totalScoreFloat <= 1.0) { category = "Excellent / Low Risk"; emoji = "üü¢"; barColor = "#1b8f3a"; }
  else if (totalScoreFloat <= 2.0) { category = "Mild Risk"; emoji = "üü°"; barColor = "#e6c200"; }
  else if (totalScoreFloat <= 3.0) { category = "Elevated Risk"; emoji = "üü†"; barColor = "#ff8c00"; }
  else { category = "High / Very High Risk"; emoji = "üî¥"; barColor = "#e02424"; }

  // show results (always for both actions)
  form.style.display = 'none';
  resultsDiv.style.display = 'block';
  document.getElementById('responseID').textContent = `Response ID: ${responseID}`;
  document.getElementById('totalPoints').textContent = `Total Score: ${totalScore} (avg 0‚Äì4)`;
  document.getElementById('categoryColor').textContent = `${category} ${emoji}`;

  // breakdown
  document.getElementById('breakdown').innerHTML = `
    <b>Breakdown</b>
    <ul class="breakdown-list">
      <li>Stress (avg 0‚Äì4): ${stressScore.toFixed(2)}</li>
      <li>Habits (avg 0‚Äì4): ${habitsScore.toFixed(2)}</li>
      <li>Nutrition (0‚Äì4): ${nutritionScore}</li>
      <li>Physical (0‚Äì4): ${physicalScore}</li>
      <li>Medical (count 0‚Äì4): ${medicalScore}</li>
    </ul>
  `;

  // build bars (each component 0..4 scaled to 0..100%)
  const components = [
    { label: "Stress", value: stressScore },
    { label: "Habits", value: habitsScore },
    { label: "Nutrition", value: nutritionScore },
    { label: "Physical", value: physicalScore },
    { label: "Medical", value: medicalScore }
  ];

  barChart.innerHTML = "";
  components.forEach(c => {
    const pct = Math.round((c.value / 4) * 100);
    const row = document.createElement('div');
    row.className = 'bar-row';

    const fill = document.createElement('div');
    fill.className = 'bar-fill';
    fill.style.width = pct + '%';

    // color by ratio (keeps contrast)
    const ratio = c.value / 4;
    if(ratio <= 0.25) fill.style.background = '#84c88a';
    else if(ratio <= 0.5) fill.style.background = '#ffc107';
    else if(ratio <= 0.75) fill.style.background = '#ff9800';
    else fill.style.background = '#f44336';

    // left short label (component name)
    const leftLabel = document.createElement('div');
    leftLabel.className = 'bar-label-left';
    leftLabel.textContent = c.label;

    // centered text ALWAYS visible, black, placed over bar (so visible even if fill is very small)
    const centerText = document.createElement('div');
    centerText.className = 'bar-text';
    centerText.textContent = `${(c.value).toFixed(1)} / 4  ‚Äî  ${pct}%`;

    row.appendChild(fill);
    row.appendChild(leftLabel);
    row.appendChild(centerText);
    barChart.appendChild(row);
  });

  // prepare payload (full data)
  const payload = {
    response_id: responseID,
    timestamp: new Date().toISOString(),
    demographics: {
      age: form.age.value,
      gender: form.gender.value
    },
    medical_conditions: medicalList.length ? medicalList : ["None"],
    nutrition: nutritionScore,
    physical: physVal,
    habits: {
      alcohol: alcohol,
      tobacco: tobacco,
      drugs: drugs,
      gambling: gambling
    },
    stress_answers: stressAnswers,
    totals: {
      stress_avg: Number(stressScore.toFixed(2)),
      habits_avg: Number(habitsScore.toFixed(2)),
      nutrition: nutritionScore,
      physical: physicalScore,
      medical_count: medicalScore,
      enhanced_stress_index: Number(totalScore)
    },
    category: category,
    emoji: emoji,
    email: form.email.value || null
  };

  // If user clicked "individual" -> POST then redirect to Payment.html
  if(action === 'individual'){
    try{
      const resp = await fetch(EDGE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      // log server response if any (best-effort)
      const text = await resp.text().catch(()=>null);
      console.log("Edge response status:", resp.status, text);
      // after POST success (or even if non-200) redirect to payment page
      window.location.href = "Payment.html";
      return; // stop here because we're leaving page
    }catch(err){
      console.error("POST error:", err);
      // still redirect to payment to keep flow (but you can change to show error)
      window.location.href = "Payment.html";
      return;
    }
  }

  // If action === 'index' -> do NOT POST, only show results (we already showed)
});

/* ---------- reset button ---------- */
document.getElementById('newFormBtn').addEventListener('click', ()=> {
  form.reset();
  form.style.display = 'block';
  resultsDiv.style.display = 'none';
  barChart.innerHTML = '';
});

</script>
</body>
</html>
